name: Built-in Cache Performance Test (Ubuntu & Windows)

on:
  workflow_dispatch:

jobs:
  create-large-dependency:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate large cacheable dependency (~300MB)
        run: |
          mkdir -p biglib
          for i in $(seq 1 30); do
            dd if=/dev/urandom of=biglib/random_$i.bin bs=1M count=10
          done
          du -sh biglib

      - name: Ensure package.json exists and name is valid
        run: |
          if [ ! -f package.json ]; then
            npm init -y
          fi
          # Replace invalid name if present
          jq '.name = "setupnode-975-test"' package.json > tmp.$$.json && mv tmp.$$.json package.json

      - name: Add biglib as dependency (via postinstall script)
        run: |
          jq '.scripts["postinstall"] = "cp -r ./biglib ./node_modules/"' package.json > tmp.$$.json && mv tmp.$$.json package.json

      - name: Generate yarn.lock
        run: yarn install

      - name: Upload artifacts for next job
        uses: actions/upload-artifact@v4
        with:
          name: generated-artifacts
          path: |
            yarn.lock
            package.json
            biglib

  cache-restore-test:
    needs: create-large-dependency
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated-artifacts

      - name: Setup Node with yarn cache enabled
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install dependencies and measure restore performance
        shell: bash
        run: |
          start_time=$(date +%s)
          yarn install
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "Dependency installation (including cache restoration) took: $duration seconds"
          du -sh node_modules || du -sh .yarn/cache || dir .yarn\cache